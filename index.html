<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document Scanner</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.0.2/tesseract.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    #camera, #capturedImage {
      display: block;
      margin: 10px auto;
      max-width: 100%;
    }

    input {
      display: block;
      margin: 10px 0;
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      padding: 10px 20px;
      background-color: #007BFF;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <h1>Document Scanner</h1>

  <!-- Camera Feed -->
  <video id="camera" autoplay playsinline></video>
  <canvas id="canvas" style="display: none;"></canvas>

  <!-- Buttons -->
  <button id="captureBtn">Capture</button>

  <!-- Captured Image -->
  <img id="capturedImage" alt="Captured Image" style="display:none;">

  <!-- Inputs for Extracted Data -->
  <label>First Name</label>
  <input type="text" id="firstname" placeholder="First Name">

  <label>Middle Name</label>
  <input type="text" id="middlename" placeholder="Middle Name">

  <label>Last Name</label>
  <input type="text" id="lastname" placeholder="Last Name">

  <label>Date of Expiration</label>
  <input type="text" id="expiration" placeholder="Date of Expiration">

  <label>Plate Number</label>
  <input type="text" id="plateNumber" placeholder="Plate Number">

  <script>
    const video = document.getElementById('camera');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    const capturedImage = document.getElementById('capturedImage');
    const captureBtn = document.getElementById('captureBtn');

    // Start Camera
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" }, // Use front camera
          audio: false
        });
        video.srcObject = stream;
      } catch (error) {
        console.error("Error accessing camera:", error);
        alert("Could not access the camera. Please allow camera permissions.");
      }
    }

    // Preprocess Image
    function preprocessImage(video) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Grayscale and Threshold (Binarize)
      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;

      for (let i = 0; i < data.length; i += 4) {
        const grayscale = 0.3 * data[i] + 0.59 * data[i + 1] + 0.11 * data[i + 2];
        const threshold = grayscale > 128 ? 255 : 0; // Binarize
        data[i] = data[i + 1] = data[i + 2] = threshold;
      }

      context.putImageData(imageData, 0, 0);
      return canvas.toDataURL('image/png');
    }

    // Capture and Process Image
    captureBtn.addEventListener('click', () => {
      const processedImage = preprocessImage(video);
      capturedImage.src = processedImage;
      capturedImage.style.display = 'block';

      extractTextFromImage(processedImage);
    });

    // Extract Text using Tesseract
    function extractTextFromImage(imageData) {
      Tesseract.recognize(imageData, 'eng', {
        logger: info => console.log(info),
        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789 /:', // Allow only valid characters
        tessedit_pageseg_mode: 6 // Single block of text
      }).then(({ data: { text } }) => {
        console.log("Extracted Text:", text);
        processTextWithNLP(text);
      }).catch(err => console.error("OCR Error:", err));
    }

    // NLP-like Processing: Extract Specific Data
    const dataFields = ['firstname', 'middlename', 'lastname', 'expiration', 'plateNumber'];

    function processTextWithNLP(text) {
      const extractedData = {
        firstname: '',
        middlename: '',
        lastname: '',
        expiration: '',
        plateNumber: ''
      };

      const lines = text.split('\n');
      lines.forEach(line => {
        const lowerLine = line.toLowerCase();

        // Custom rules for extracting fields
        if (/\d{2}\/\d{2}\/\d{4}/.test(line)) {
          extractedData.expiration = line.match(/\d{2}\/\d{2}\/\d{4}/)[0];
        } else if (/plate/i.test(line) || /\b[A-Z]{3}-\d{4}\b/.test(line)) {
          extractedData.plateNumber = line.match(/\b[A-Z]{3}-\d{4}\b/)[0] || '';
        } else if (line.split(' ').length === 2 || line.split(' ').length === 3) {
          const nameParts = line.split(' ');
          extractedData.firstname = nameParts[0] || '';
          extractedData.lastname = nameParts.slice(-1)[0] || '';
          if (nameParts.length === 3) {
            extractedData.middlename = nameParts[1] || '';
          }
        }
      });

      populateInputs(extractedData);
    }

    // Populate Inputs
    function populateInputs(data) {
      document.getElementById('firstname').value = data.firstname;
      document.getElementById('middlename').value = data.middlename;
      document.getElementById('lastname').value = data.lastname;
      document.getElementById('expiration').value = data.expiration;
      document.getElementById('plateNumber').value = data.plateNumber;
    }

    // Start Camera on Load
    window.onload = startCamera;
  </script>
</body>
</html>
